---
title: "Logistics regression: Assessing factors that inlfuence client conversion"
description: |
  This post uses logistic regression to support sales team to decipher the impact of various factors on their conversion rate.
author:
  - name: Linus Agbleze
    url: https://agbleze.github.io/Portfolio/
date: 2022-09-04
output:
  distill::distill_article:
    self_contained: false
    
draft: false
categories: logistic regression
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```


## Objective 4: Assessing factors that influence the likelihood of a client to convert

The fourth objective of the product analysis is to move a step further and assess our data with focus on predicting how various factors influence the probability of a client signing up for our product. In order to achieve the goal of higher amount of conversion, as assessment is undertaken to model whether or not a client will sign-up. Knowing how these factors influence client's decision to purchase our service will enable us better target clients by managing such predictors well. For this, a review of the various variables available has been undertaken to identify potential predictors. 

The business problem at hand can be translated into an analytical one that requires a classification solution. In this case, the aim is to classify clients into two groups of convert and non-convert. This is the outcome we seek to predict hence the response or dependent variable. The response variable has two categories or classes as indicated, conversion and non-conversion, hence a regression analysis that caters for such characteristics is chosen. 


### Method: Logistic regression
Logistic regression will be used for assessing how various factors influence the probability of a client deciding to convert.

Based on the available limited data guided with domain knowledge of the business operations, the potential predictors identified for the analysis are the following

1. Type of sales script
2. Company type

###  Description of predictors and rational for their selection

1. The relationship between the type of sales script and conversion has been our main focus for earilier analysis and yet it is still important to understand how they influence the actual decision to convert and not the total number of conversion this time round. It can be presume, as it is the case to hypothesize, that there is a logical understanding of type of sales script being a potential influential determinant.

2. Company type as a potential predictor is based on the assumption that the characteristics of the company will determine its decision to finally purchase our product. Given that, these features are not adequately disclosed, the difference in labelling of company type is taken to be directly related to difference in company characteristics.



### Data treatment / preprocessing 
Some predictors have receive a special focus different from earlier, in order to prepare the variables into an acceptable format for modeling. It is worthing highlight such instances for transparency and reproducability of the analysis.

First of all, the company type variable had two categories being 0 and 1, and several missing data in the original dataset. In this case, it is possible that the missiing data was just an instance of unavailable data that was not provided due to some privacy concerns. Moreover, as much as 4,916 missing data is identified in the original dataset which constitutes a sizeable part of the dataset to eliminte from the analysis and very likely to reduce the possibility of capturing as much variations as the reality is on the ground. Supported by this, is the fact that, such a large amount of missing data is enough to constitute a category in its own right for analysis and insight. Based on these available information and context, the decision was made to replace all instances of missing data for company type with 'Others' as another company type. This led to reclassification of company type into company group A, B and Others corresponding to 0, 1 and missing data respectively;



```{r, warning=FALSE, message=FALSE}
library(readr)
library(ggplot2)
library(tidyverse)
library(lubridate)
library(forecast)
library(fpp2)
library(GGally)
library(caret)
library(dplyr)
library(DT)
library(formattable)
#library(fontawesome)
#library(shiny)
#library(shinydashboard)
library(devtools)
library(ggplot2)
library(magrittr)
library(plotly)
library(purrr)
#library(shinyWidgets)
library(tibble)
library(utils)
#library(bslib)
#library(shiny)
#library(shinydashboard)
#library(shinycssloaders)
#library(shinyanimate)
#library(shinydashboardPlus)
#library(shinyEffects)
#library(shinybusy)
#library(shinyBS)
library(ggstatsplot)
library(bfast)
library(broom)
library(MASS)
library(yarrr)
library(modelr)
library(ROCR)
```




```{r, message=FALSE}
#applicant_task <- read_csv("applicant_task.csv")

applicant_task <-read_csv('/Users/lin/Documents/DS_blog/docs/_posts/2022-09-04-logistics-regression/applicant_task.csv')

task_data = applicant_task

#### add conversion column
task_data_convert <- task_data %>%
  mutate(conversion = case_when(
    is_signed == 1 ~ 'convert',
    is_signed == 0 ~ 'not_convert'
  ),
  sales_script_type = case_when(
    sales_script_variant == "a170e8b5b0085420fa52f9f9e1d546f9" ~ 'script_A',
    sales_script_variant == "e908f62885515872936a2bf07e5960a0" ~ 'script_B',
    sales_script_variant == "21790c97eeb6336e5f0fdb9ef4de636f" ~ 'script_C'
  ),
  company_group = case_when(
    company_type == 0 ~ 'company_A',
    company_type == 1 ~ 'company_B',
    company_type == NA ~ 'company_others'
  )) %>%
  mutate(request_created_date = as_datetime(request_created_at),
         first_call_date = as_datetime(first_call),
         first_reach_date = as_datetime(first_reach),
         request_created_year = year(request_created_date),
         request_created_month = month(request_created_date, label = TRUE, abbr = FALSE),
         request_to_1stcall_interval = interval(start = request_created_date, end = first_call_date),
         request_to_1streach_interval = interval(start = request_created_date, end = first_reach_date),
         first_call_to_1streach_interval = interval(start = first_call_date, end = first_reach_date),
         #   request_to_1stcall_timediff = as.period(request_to_1stcall_interval),
         request_to_1stcall_timelength_minutes_ = time_length(request_to_1stcall_interval, unit = 'minute'),
         request_to_1streach_timelength_minutes_ = time_length(request_to_1streach_interval, unit = 'minute'),
         first_call_to_1streach_timelength_minutes_ = time_length(first_call_to_1streach_interval,
                                                                  unit = 'minute'))#%>%


```



```{r, message=FALSE}

train_data <- read_csv("/Users/lin/Documents/DS_blog/docs/_posts/2022-09-04-logistics-regression/train_data.csv")

test_data <- read_csv("/Users/lin/Documents/DS_blog/docs/_posts/2022-09-04-logistics-regression/test_data.csv")

table(train_data$conversion)
table(test_data$conversion)

train_data$company_group  = factor(x = train_data$company_group, levels = c("Others", "company_A", "company_B"))
levels(train_data$company_group)


train_logit = glm(is_signed ~ company_group + sales_script_type, data = train_data, family = 'binomial')
summary(train_logit)
#tidy(train_logit)
#exp(coef(train_logit))

#varImp(train_logit)  ## determine which variable is more influencial in determining conversion

#predict(train_logit, test_data, type = 'response')

```



### Insights from multiple logistic regression

The logistic regression for predicting the probability that a client will sign-up produced a non-significant p-value for all cases. Script A was used as reference point for script B and C. Thus, with a co-efficient of -0.049 for script B, it is suggested that using script B results in a decrease in the log odds of signing a client by 0.049 in comparison to script A. This is however statistically insignificant. Script C has a co-efficient of 0.24 which suggests that when a sales manager uses script C, the log odds of signing a client increases by 0.24 compared to script A which is statistically insignificant.


With regards to prioritizing companies to reach out to in order to increase conversion, when sales managers take a session with company A or company B, the log odds of landing a conversion increases compared to when they target companies categorized as 'Others' in this analysis. The result is however statistically insignificant.


### Recommendation for objective 4

From the analysis undertaken, it is recommended that the sales team consider not prioritizing demo sessions with company type 'Others'. This should however not be treated as a de facto discrimination favouring company A and B to increase conversion given that the results are statistically insignificant.  



```{r, message=FALSE, error=FALSE}
mcfadden_r2 <- pscl::pR2(train_logit)["McFadden"] ### With McFadden pseudo-r2 value of 0.0005871432, the model has
## very low predictive power which suggest the need to consider inclusion of serveral other better predictors

model1_data <- augment(train_logit) %>% 
  mutate(index = 1:n())

# # ggplot(model1_data, aes(index, .std.resid, color = is_signed)) + 
#   geom_point(alpha = .5) +
#   geom_ref_line(h = 3)

test.predicted.m1 <- predict(train_logit, newdata = test_data, type = "response")

model1 = table(test_data$is_signed, test.predicted.m1 > 0.5) %>% prop.table() %>% round(3)

```


```{r, message=FALSE, error=FALSE}
prediction_data <- test_data %>%
  mutate(model_prediction = ifelse(test.predicted.m1 > 0.5, "convert", "not_convert"))%>%
  mutate(predict_satus = ifelse(conversion == model_prediction, 'Correct prediction', 'Wrong prediction'))

## confusion matrix
confusion_matrix <- table(test_data$conversion, test.predicted.m1 > 0.5)

## The confusion matrix indicated that the model correctly predicted 858 conversions out of a total of 2017,
## which a precision rate of 42.5384% (sensitivity). Also, the model correctly predicted 1119 non-conversions
## out of a total of 1983 non-conversions which is a specificity rate of 56.429%. Given that we are more
## interested in successfully prediction conversion, the predictors in the model are not optimal hence
## the need for better predictors to improve the model. The model needs to be tuned to improve
## sensitivity.

```



```{r, message=FALSE}
sensitivity_result = (confusion_matrix[1,2] / (confusion_matrix[1,1] + confusion_matrix[1,2])) *100
specificity_result = (confusion_matrix[2,1] / (confusion_matrix[2,1] + confusion_matrix[2,2])) * 100

### AUC is measured on a scale of 0.5 to 1.0 with higher value indicate better classifying model
auc <- prediction(test.predicted.m1, test_data$is_signed) %>%
  performance(measure = "auc") %>%
  .@y.values
auc
### the model has AUC of 0.5012221 hence a poor classifying model


prediction(test.predicted.m1, test_data$is_signed) %>%
  performance(measure = "tpr", x.measure = "fpr") %>%
  plot() + title(main = paste0('AUC= ', comma(auc, digits = 2)))
#ggcoefstats(train_logit, output = 'plot') + theme_grey()






var_influeunce <- varImp(train_logit)  ## determine which variable is more influencial in determining conversion
```





